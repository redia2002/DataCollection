<h2>WAP の再構成に失敗する場合に取得する資料</h2>
<br>
<br>
<input type="button" value="COPY" onclick="cp()" class="adfsbutton">
<br>
<br>
<h5>■ご留意事項<br></h5>
<h5>
    今回ご案内させていただきます資料採取は、多くのお客様の環境で採取した実績があり、通常はシステムの運用に影響を与えるものはございません。<br>
    しかしながら、元々システム リソースが不足している環境などでは影響を及ぼす可能性がございますので、念のため事前に CPU 使用率やメモリ使用量が恒常的に高騰していないこと、ストレージの空き領域が十分に (10 GB 以上) 存在することをご確認ください。<br>
</h5>
<br>
<br>
<h5>■情報採取の流れ<br></h5>
<h5>
    ここでは、大まかな情報採取の流れをご説明いたします。<br>
    個々の資料の詳細な取得手順は後述いたしますので、併せてご確認いただけますようお願い申し上げます。<br>
    <br>
    ・事前準備<br>
    最初に、WAP サーバーで事前準備を行います。<br>
    <br>
    ・資料採取<br>
    1. WAP サーバーおよびプライマリ AD FS サーバーで、「(A) CAPI2 ログ」の「取得開始手順」を実施し、事象の再現前まで手順を進めます。<br>
    2. WAP サーバーおよびプライマリ AD FS サーバーで、「(B) Schannel トレース」の「取得開始手順」を実施し、事象の再現前まで手順を進めます。<br>
    3. WAP サーバーおよびプライマリ AD FS サーバーで、「(C) ネットワーク トレース」の「取得開始手順」を実施し、事象の再現前まで手順を進めます。<br>
    4. WAP サーバーおよびプライマリ AD FS サーバーで、「(D) AD FS デバッグログ」の「取得開始手順」を実施し、事象の再現前まで手順を進めます。<br>
    5. WAP サーバーで、「(E) PSR」 の「取得開始手順」を実施し、事象の再現前まで手順を進めます。<br>
    <br>
    6. WAP サーバーでウィザードを実行し、事象を再現します。<br>
    <br>
    7. WAP サーバーおよびプライマリ AD FS サーバーで、「(D) AD FS デバッグログ」の「取得完了手順」を実施し、資料の採取を行います。<br>
    8. WAP サーバーおよびプライマリ AD FS サーバーで、「(C) ネットワーク トレース」の「取得完了手順」を実施し、資料の採取を行います。<br>
    9. WAP サーバーおよびプライマリ AD FS サーバー、「(B) Schannel トレース」の「取得完了手順」を実施し、資料の採取を行います。<br>
    10. WAP サーバーおよびプライマリ AD FS サーバー、「(A) CAPI2 ログ」の「取得完了手順」を実施し、資料の採取を行います。<br>
    11. WAP サーバーおよびプライマリ AD FS サーバーで、「(F) スクリプトによる情報採取」を行います。<br>
    12. WAP サーバーで、「(E) PSR」の「取得完了手順」を実施し、資料の採取を行います。<br>
</h5>
<br>
<br>
<h5>■事前準備<br></h5>
<h5>
    1. WAP サーバーの hosts ファイルに、フェデレーションサービス名の名前解決先として、プライマリの AD FS サーバーの IP アドレスを設定します。<br>
    ping 【フェデレーションサービス名の FQDN】 と実行し、プライマリの AD FS サーバーと通信できることを確認してください。<br>
    <br>
    2. プロキシサーバーの設定を確認します。<br>
    WAP と AD FS サーバー間は、一般的には社内ネットワークで通信を行うため、インターネットに接続するためのプロキシを設定している場合、バイパスするように設定します。<br>
    <br>
    [プロキシのバイパス方法]<br>
    ---------------------------------------<br>
    (1) ウィザードを実行する管理者ユーザーで WAPサーバーにログオンし、IE を起動します。<br>
    <br>
    (2) [インターネット オプション] - [接続] - [LANの設定] - [詳細設定] を開きます。<br>
    <br>
    (3) [例外] に、プロキシをバイパスするアドレスを設定します。<br>
    例えば、フェデレーションサービス名が sts.federation.com、オンプレミスのドメインが test.com の場合には、以下のように設定します。<br>
    sts.federation.com;*.test.com;test.com<br>
    <br>
    ";" でバイパスするアドレスを列挙します。上記の例ですと、<br>
    <br>
    sts.federation.com<br>
    *.test.com<br>
    test.com<br>
    <br>
    については、プロキシをバイパスするようになります。<br>
    *.test.com および test.com については、ドメインへの接続についてもバイパスするように設定している例です。<br>
    <br>
    <br>
    (4) 上記の設定を、WINHTTP にも設定します。<br>
    管理者権限でコマンドプロンプトを起動し、以下のようにコマンドを実行します。<br>
    <br>
    > netsh winhttp import proxy source=ie<br>
    <br>
    <br>
    (5) 併せて、NETWORK SERVICE アカウントにも設定します。<br>
    コマンドプロンプトを管理者権限で起動し、<br>
    <br>
    bitsadmin /util /setieproxy NetworkService MANUAL_PROXY 【proxy server の host】 "【バイパスリスト】" <br>
    <br>
    と実行します。<br>
    <br>
    (実行例)<br>
    > bitsadmin /util /setieproxy NetworkService MANUAL_PROXY 192.168.1.1:8080 "&lt;local>;sts.federation.com;*.test.com;test.com"<br>
    <br>
    <br>
    (6) machine.config の設定を確認します。<br>
    C:\Windows\Microsoft.NET\Framework64\v4.0.30319\Config\machine.config に、&lt;defaultProxy> タグを追記して Proxy を設定している場合、&lt;bypasslist> に上記と同様に設定を行ってください。<br>
    machine.config の編集を行っていない場合、対応は不要です。<br>
    ---------------------------------------<br>
</h5>
<br>
<br>
<h5>■情報採取手順詳細<br></h5>
<h5>
    ================================<br>
    (A) CAPI2 ログ<br>
    ================================<br>
    - 取得開始手順：<br>
    1. イベントビューアを開きます。<br>
    ([スタート] - [ファイル名を指定して実行] を順に選択し、eventvwr と入力後、OKボタンをクリックします。)<br>
    <br>
    2. 左ペインのツリーを、下記のとおり展開します。<br>
    [アプリケーションとサービス ログ] - [Micorosoft] - [Windows] - [CAPI2] - [Operational]<br>
    <br>
    3. [Operational] を右クリックし、プロパティを開きます。<br>
    4. プロパティ画面にて、[ログの有効化] にチェックを入れます。<br>
    5. プロパティ画面にて、[最大ログ サイズ] を、"102400 (KB)” に変更し、OK ボタンをクリックします。<br>
    <br>
    <br>
    この後事象を再現しますが、他の種類の資料を採取する場合には、先にそちらについても事象の再現前まで手順を進めます。<br>
    <br>
    <br>
    - 取得完了手順：<br>
    事象の再現が終わりましたら、[アプリケーションとサービスログ] - [Microsoft] - [Windows] - [CAPI2] - [Operational] を選択し、[ログの無効化] を選択します。<br>
    ログは、スクリプトでまとめて採取されます。<br>
    <br>
    <br>
    ================================<br>
    (B) Schannel トレース<br>
    ================================<br>
    - 取得開始手順:<br>
    1. コマンドプロンプトを管理者権限で開きます。<br>
    (管理者権限で開くためには、スタートメニューで "コマンド プロンプト" を右クリックし「管理者として実行」 をクリックします)<br>
    <br>
    2. cd コマンドでログファイルを出力したいディレクトリに移動 (例: cd c:\temp) し、以下のコマンドを実行します。<br>
    <br>
    logman -start schannel -p {37d2c3cd-c5d4-4587-8531-4696c44244c8} 0x4000ffff 3 -ets<br>
    <br>
    3. コマンドを実行したディレクトリに "Schannel.etl" というファイルが生成され、ログ記録が開始されます。<br>
    <br>
    <br>
    この後事象を再現しますが、他の種類の資料を採取する場合には、先にそちらについても事象の再現前まで手順を進めます。<br>
    <br>
    <br>
    - 取得完了手順:<br>
    1. 上記の取得開始手順を実行したコマンドプロンプトで、以下のコマンドを実行します。<br>
    <br>
    logman -stop SChannel -ets<br>
    <br>
    2. コマンドを実行したカレント ディレクトリに "Schannel.etl" というファイルが保存されますので、このファイルを採取ください。<br>
    <br>
    <br>
    ================================<br>
    (C) ネットワーク トレース<br>
    ================================<br>
    - 取得開始手順:<br>
    1. コマンドプロンプトを管理者権限で開きます。<br>
    (管理者権限で開くためには、スタートメニューで "コマンド プロンプト" を右クリックし「管理者として実行」 をクリックします)<br>
    <br>
    2. 以下のコマンドを実行します。<br>
    <br>
    netsh trace start capture=yes maxSize=2000M<br>
    <br>
    * 最大で 2GB までパケットをキャプチャします。<br>
    <br>
    3. 以下 5 つのコマンドを実行してキャッシュ情報を削除します。 <br>
    <br>
    ipconfig /flushdns<br>
    <br>
    nbtstat -R<br>
    <br>
    klist purge<br>
    <br>
    klist purge -li 0x3e4<br>
    <br>
    klist purge -li 0x3e7<br>
    <br>
    <br>
    この後事象を再現しますが、他の種類の資料を採取する場合には、先にそちらについても事象の再現前まで手順を進めます。<br>
    <br>
    <br>
    - 取得完了手順:<br>
    上記の取得開始手順を実行したコマンドプロンプトで、以下のコマンドを実行します。<br>
    <br>
    netsh trace stop<br>
    <br>
    トレース ファイルの収集処理が完了しましたら "ファイルの場所" に出力された "NetTrace.etl" 、及び "NetTrace.cab" の 2 つのファイルをご提供下さい。 <br>
    <br>
    <br>
    ================================<br>
    (D) AD FS デバッグログ<br>
    ================================<br>
    - 取得開始手順:<br>
    1. コマンドプロンプトを管理者権限で開きます。<br>
    (管理者権限で開くためには、スタートメニューで "コマンド プロンプト" を右クリックし「管理者として実行」 をクリックします)<br>
    <br>
    2. 次のコマンドを実行し、AD FS デバッグ ログのレベルを設定します。 <br>
    <br>
    wevtutil sl "AD FS Tracing/Debug" /l:5<br>
    <br>
    ※ 下記手順 5. が既に有効化されている場合はこのコマンドでエラーが発生します。その場合は、事前に無効にしてからこのコマンドを実施ください。<br>
    <br>
    3. [イベント ビューアー] を起動し、[表示] - [分析およびデバッグ ログの表示] にチェックを入れます。<br>
    4. 左ペインのツリーを、下記のとおり展開します。 <br>
    <br>
    [アプリケーションとサービス ログ] - [AD FS Tracing] - [Debug]<br>
    <br>
    5. [Debug] を右クリックし、[ログの有効化] を選択します。<br>
    <br>
    <br>
    この後事象を再現しますが、他の種類の資料を採取する場合には、先にそちらについても事象の再現前まで手順を進めます。<br>
    <br>
    <br>
    - 取得完了手順:<br>
    資料採取が終わりましたら、[アプリケーションとサービス ログ] - [AD FS Tracing] - [Debug] を選択し、[ログの無効化] を選択します。<br>
    ログは、スクリプトでまとめて採取されます。<br>
    <br>
    <br>
    ================================<br>
    (E) PSR<br>
    ================================<br>
    - 取得開始手順:<br>
    1. 不要な情報の採取を避けるために、全てのウィンドウを閉じます。<br>
    2. スタート メニューの [ファイル名を指定して実行] にて psr.exe と入力し、[OK] をクリックします。 <br>
    3. "問題ステップ記録ツール" が起動しましたら、右端の ▼ をクリックし、表示されるメニューから [設定]をクリックします。 <br>
    4. "保存する最新の取り込み画像数" を 25 から 100 に変更し、OK をクリックします。 <br>
    5.  [記録の開始] をクリックします。 <br>
    6. "問題ステップ記録ツール" の画面を最小化します。 <br>
    <br>
    <br>
    この後事象を再現しますが、他の種類の資料を採取する場合には、先にそちらについても事象の再現前まで手順を進めます。<br>
    <br>
    <br>
    ※ PSR 採取におけるご注意<br>
    PSR はマウスのクリックのタイミングで各種情報のキャプチャを行います。<br>
    全ての情報を正しくキャプチャするために、文字入力などが必要な時 (認証情報入力時など) 以外は、マウスでの操作を行うようにしてください。<br>
    キーボードの Esc キー、Tab キー、Space キー、Enter キー、ショートカット キーなどによる画面操作は行わないでください。<br>
    これらの操作が行われますと、意図した情報が得られず、再度の採取依頼となる可能性がございます。<br>
    <br>
    事象を再現させた後に、最後に画面の何もないところをマウスでクリックします。 <br>
    ※ 最後の画面も確実に採取するため、必ず一度クリックをして下さい。<br>
    <br>
    <br>
    - 取得完了手順<br>
    1. "問題ステップ記録ツール" の画面を前面に出します。 <br>
    2. ファイルの保存場所、ファイル名を指定し、保存致します。 <br>
    3. 作成されました ZIP ファイルを採取して下さい。<br>
    <br>
    <br>
    ================================<br>
    (F) スクリプトによる情報採取<br>
    ================================<br>
    1. GitHub の下記 URL にアクセスし、"Clone or download" から Download ZIP を選択して "adfs-diagnostic-master.zip" をダウンロードします。<br>
    https://github.com/jpazureid/adfs-diagnostic<br>
    <br>
    2. ダウンロードした ZIP ファイルを展開し、"getadfslogscript.ps1" を任意のディレクトリに配置します。<br>
    <br>
    3. PowerShell プロンプトを管理者として起動し、カレントディレクトリをスクリプトを配置したフォルダーに移動します。<br>
    ※ Windows PowerShell (x86) と表示されている PowerShell で本スクリプトを実行すると失敗します。 x86 という表記がない PowerShell を実行してください。<br>
    <br>
    4. 下記のように実行します。<br>
    .\getadfslogscript.ps1<br>
    <br>
    ※ スクリプトの実行が許可されていない (Restricted) 場合は、下記コマンドを利用してスクリプトを実行することが可能です。<br>
    Powershell.exe -ExecutionPolicy Bypass -File .\getadfslogscript.ps1<br>
    <br>
    5. PowerShell 実行カレント フォルダー上に [実行日時]_hostname でフォルダーが作成され、その配下に各種ログが出力されます。<br>
    ※ 構成によってはエラーが返ってくる場合もございますが、無視してください。<br>
    <br>
    6. 実行完了後、 PowerShell 画面に表示された保存先フォルダーを ZIP 等で圧縮し、弊社までお寄せください<br>
</h5>
<br>
<br>
<h5>
    ---------------------------------------<br>
    情報のアップロードにつきまして<br>
    ---------------------------------------<br>
    お手数をおかけいたしますが、以下の手順で採取した情報をアップロードいただきますようお願いいたします。<br>
    <br>
    1. 下記 リンク にアクセスします。<br>
    <br>
    ################# アップロードサイトのリンク #################<br>
    <br>
    2. 右上部の “+ ファイルの追加” をクリックします。<br>
    3. 表示されるダイアログで、アップロードをするファイルを選択することでアップロードされます。<br>
    4. アップロードが完了したことを弊社までご一報ください。<br>
</h5>
<br>
<br>
<h5>@Html.ActionLink("Back", "Index", "Adfs")</h5>
<h5>@Html.ActionLink("Back to Top", "Index", "DataCollection")</h5>
